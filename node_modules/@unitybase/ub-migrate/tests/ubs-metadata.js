const test = require('tape')
const yaml = require('js-yaml')
const utility = require('../lib/metadata/utility')
const {Container} = require('../lib/metadata')
const {LocaleResources} = require('../lib/locale-resources')

/** @type {MigrationContext} */
const ctx = {
  conn: null,
  langConfig: {defaultLang: 'en', supportLang: ['en', 'uk']},
  options: {silent: true},
  container: new Container({silent: true}),
  resources: new LocaleResources()
}

require('../lib/registration/ubs-metadata')(ctx.container)

test('Settings', t => {

  t.deepEquals(
    Array.from(utility.transformAndTranslate(
      utility.iterateList(yaml.safeLoad(`
setting1:
  name: My setting
  type: number
  defaultValue: '10'
  settingValue: '20'
setting2:
  name: Another
  description: no desc
  type: string
  defaultValue: yes
  settingValue: no
`)),
      ctx.container.getFileType('settings'),
      ctx
    )),
    [
      {
        entity: 'ubs_settings',
        execParams: {
          settingKey: 'setting1', type: 'number',
          'name_en^': 'My setting', 'name_uk^': 'My setting',
          'description_en^': 'My setting', 'description_uk^': 'My setting',
          'defaultValue_en^': '10', 'defaultValue_uk^': '10',
          'settingValue_en^': '20', 'settingValue_uk^': '20',
        }
      },
      {
        entity: 'ubs_settings',
        execParams: {
          settingKey: 'setting2', type: 'string',
          'name_en^': 'Another', 'name_uk^': 'Another',
          'description_en^': 'no desc', 'description_uk^': 'no desc',
          'defaultValue_en^': 'yes', 'defaultValue_uk^': 'yes',
          'settingValue_en^': 'no', 'settingValue_uk^': 'no'
        }
      }],
    'UBS settings'
  )

  t.end()
})
