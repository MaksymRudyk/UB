# Change Log
All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](http://keepachangelog.com/)
and this project adheres to [Semantic Versioning](http://semver.org/).

## [Unreleased]
### Added

### Changed

### Deprecated

### Removed

### Fixed

## [1.22.9] - 2021-09-27
### Fixed
- Value of `defaultCustomerModel` in context for ubConfig.json with no customer models.

## [1.22.8] - 2021-08-17
### Changed
- `cdn_country.fullName` default value set to `cdn_country.name`

## [1.22.7] - 2021-08-17
### Changed
- `cdn_currency.curMult` default value set to 100

## [1.22.6] - 2021-08-17
### Added
- Support for `cdn_currency` and `cdn_country`

## [1.22.5] - 2021-07-18
### Changed
 - in case localization of some attribute in yaml not found - fallback to `en`.
   This fix migration for applications with defaultLang !== 'en' (az for example) and missed keys localization  

## [1.22.4] - 2021-06-30
### Changed
 - in case of error during YAML parsing - include a full file path into error text

## [1.22.3] - 2021-06-30
### Fixed
- Handled case when `getDocument` fails.  This may happen due to corrupted BLOB store, for example manually deleted file.
  `getDocument` query needed for comparison expected and actual values in DB.

## [1.22.2] - 2021-05-25
### Fixed
- Typo in code related to support of relPath for files

## [1.22.1] - 2021-05-17
### Fixed
- Now uba file formats for shortcuts ensures that repository it looks up are loaded, which is important for
  tenant initialization

## [1.22.0] - 2021-05-12
### Added
- Support for setting `relPath` for document attributes, which use mdb store.
  It may be configured like this:

  ```
  new EntityFormat()
    .key('code')
    .caption('name')
    .defaultValue('status', 'draft')
    .copy('register', 'formDef', 'formScript', 'events', 'history')
    .document('formScript', {fileExtension: '.js', relPath: 'designedForms'})
  ```

## [1.21.2] - 2021-04-26
### Fixed
- Fix initialization app

## [1.21.1] - 2021-04-24
### Changed
- Made loading locale resources optional, so that non CLI calls like unit-tests could skip it

## [1.21.0] - 2021-04-19
### Added
- During migration, locale resources are collected from 2 types of sources:
  - public locales, obtained from server, using `allLocales/lang=xx?json=1` query
  - JSON files in the model directory `_data/locale`, the same format as regular public locales

### Changed
** !!! BREAKING CHANGE !!!
   Requires package `@unitybase/ub@5.21.3`.  Make sure to update UB packages before update ub-migrate to this version!

### Deprecated
- Entity Format `translatable` attributes registration is not needed, this information is handled by entity repository,
  no now need to register the same information in two places.

## [1.20.0] - 2021-04-13
### Added
- Support of multi-tenant environments, by default it will iterate though all the tenants and migrate each of them
  sequentially.  Tenant bound entities are processed for all tenants, non-tenant bound entities are processed with
  tenant with TID=0 only.
  Creation of a new tenant must be initialized using the new `tid` CLI argument.

## [1.19.0] - 2021-03-02
### Changed
- `ubm_desktop_adm` and `ubm_shortcut_adm` resolve permissions in yml files to *ROLES ONLY!* (not groups, not users).
  This fixes problem, when a user is give a name, which already has a role, and ub-migration cannot properly resolve
  who is actually given permission to shortcut or desktop.

```yaml
# Specify data type
$context:
  type: navigation

bpm_desktop:
  caption: {en: Business Processes, ru: Рабочие процессы}
  description: {en: List of user tasks, started process and dashboard, ru: Список задач пользователя, запущенных процессов и дашбоард}
  access: bpmUser, bpmAdmin  # It won't try to find users or groups with such codes, it will only look for roles! 
```

## [1.18.0] - 2021-01-18
### Added
- Navigation - renderer may be set in the showList explicitly, by specifying `renderer` within `showList`:

```yaml
- dfx_DocType:
    caption: {en: Document Types, ru: Типы документов, uk: Типи документів}
    showList:
      renderer: vue
      entity: dfx_DocType
      fieldList:
      - code
      - name
```

### Changed
- Updated dependencies

## [1.17.3] - 2020-11-14
### Fixed
- `uba_role` repository - configure with `description` attribute as multi-language attributes 

## [1.17.2] - 2020-11-14
### Fixed
- Translatable attribute `uba_role.description`
- `sessionTimeout` made non-updatable

## [1.17.1] - 2020-11-05
### Changed
 - output migration statistic in a single line
 - change confused `Total skipped updates` -> `is up to date` in statistics

### Fixed
 - pass command line args to `argv.establishConnectionFromCmdLineAttributes` to prevent parsing agrs twice
 - use boolean false for `verbose` and `silent` parameters defaults (instead of string 'false') 

## [1.17.0] - 2020-11-05
### Added
  - export `exec()` method - allows using of ub-migrate from other modules
  
## [1.16.1] - 2020-10-05
### Fixed
- Regression bug with JSON attr comparison

## [1.16.0] - 2020-10-05
### Added
- Support for `ubm_desktop_acl` / `ubm_navshortcut_acl` as replacement of both `ubm_desktop_adm` / `ubm_navshortcut_adm`
  Backward compatibility remained.

### Fixed
- Document attributes did always update, now they updated only when file changed.  Comparison done for binary data.

## [1.15.0] - 2020-09-27
### Added
- Support for configuring Document attributes: file extension, file name and encoding, on "file format" level.
  For example:
  ```javascript
  container.registerFileType(
    'dfx_DocType',
    new EntityFormat()
      .key('code')
      .caption('name')
      .defaultValue('status', 'draft')
      .translatable('name', 'description')
      .copy('register', 'formDef', 'events', 'history')
      .document('formDef', {
         fileExtension: '.json'
       })
      .wrapAsEntity('dfx_DocType')
  )
  ```
  Supported options: `fileExtension`, `buildFileName`, `encoding`.
  Most of the processing is done by file format objects, the set file name pattern, encoding and content.
  Repository object is just use this info as instructed by file format.

- Support for inlining Document attribute content for file and/or override attribute configuration per attribute value

  ```yaml
  - $context:
      type: dfx_DocType
    dfx_DocType1:
      formDef:
        # Content will be read from an external file.  Path is relative to the current file 
        # Original file name in store will match the file 
        $file: './form1.json'

        # It is possible to override file name, even if read from external file (uncomment if needed)
        # $fileName: otherFileName.json 
  ```

  ```yaml
  - $context:
      type: dfx_DocType
    dfx_DocType1:
      formDef:
        # This is needed ONLY for override.  If default extension is OK, no need to specify it here
        $fileExtension: '.json'
  
        # The following syntax allows putting multiline content without extra escaping
        $content: >
          {
            "foo": "bar"
          } 
  ```

## [1.14.2] - 2020-09-25
### Fixed
- Add default extension for `Document` attributes content

## [1.14.1] - 2020-07-10
### Fixed
- Support for "showForm" with "cmdData" - automatically set "entity" where it is not set explicitly,
  into `showForm.cmdData.ubql`

## [1.14.0] - 2020-06-29
### Added
- Output command stats after run
 
### Changed
- Added `update:skip` event and call `update:after` only when NOT skipped entity update.
  Note: record skipped, if no changes detected

### Fixed
- Skip updating entity in case database contains value matching the attribute default value and yaml does not contain
  any value for that attribute 
- Convert boolean values from yaml to number, to match the type returned by UB when values loaded from DB.
- Parse JSON before comparison, because Postgres can change JSON formatting (it is stored as `jsonb` DB type,
  not `nvarchar`)

## [1.13.1] - 2020-05-19
### Added
- Support for "DENY" rules in uba roles

```yaml
role1:
  els:
    custom:
    - tst_*.selectAll*
    - tst_Entity.selectAll 
    - "!tst_Entity.delete"
    - uba_*: '*'
    - "!ubm_*": '*'
```

## [1.13.0] - 2020-05-13
### Changed
- `uba_user` sets password using `changeOtherUserPassword`

### Deprecated
- `uPasswordHashHexa` for uba_user not supported anymore

## [1.12.4] - 2020-04-08
### Fixed
- ORG execution groups - allow declaring at the top-level, no necessarily inside organization or unit

## [1.12.3] - 2020-03-30
### Fixed
- When reuse global context update value of "silent" / "verbose" options 
- For CDN and ORG repositories, change to NonCachedEntityRepository to entities, which might be big
- For all repositories made lazy load instances from DB as a cache, instead of load on repository init, this will
  improve performance

## [1.12.2] - 2020-03-24
### Changed
- Add an event `save:before`.  The driver for that event is ability to do custom lookup operations for key attributes,
  so that repository may determine if object exists or not.  The `insert:before` and `update:before` event fire too
  late, after repository fails to look key attributes up.

### Fixed
- Repository take into account possible changes in `execParams` by event handlers, when they build `fieldList`.
  This is important, when standard lookup mechanism is not enough and there is custom logic for lookup objects up.

## [1.12.1] - 2020-03-24
### Changed
- `container.registerRepository` now may be called with just one argument - repository itself, no need to
  pass entity name as the first argument, it now will be taken from the repository itself.
- `container.registerRepository` now for lookup descriptors accept repository name instead of repository itself,
  it may make registration much briefer
- `container.registerRepository` now for lookup accept `attribute` instead of `attributes` with a single string,
  which make it cleaner for majority of cases

  Note, repository as string (it MUST be registered before the call), no first parameter, `attribute`, not `attributes`,
  in other words - cleaner syntax:

```javascript
  container.registerRepository(
    new EntityRepository(
      'org_execgroupmember',
      ['orgUnitID', 'execGroupID'],
      undefined,
      [],
      [
        {repository: 'org_execgroup', attribute: 'execGroup', targetAttribute: 'execGroupID'},
        {repository: 'org_staffunit', attribute: 'orgUnit', targetAttribute: 'orgUnitID'}
      ]
    )
  )
```


## [1.12.0] - 2020-03-24
### Added
- Support for "Document" attribute type.  Just assign string value and it will be saved using `setDocument`
- Support for Many attribute type, use them as a regular lookup, but values shall be arrays instead of single string,
    ub-migrate will convert it to comma-separated ID list

### Changed
- All repository events - `insert:before`, `insert:after`, `update:before` and `update:after` - now provide `context`
  as an event property, so that inside event, it is possible to lookup values.

## [1.11.7] - 2020-03-24
### Changed
- Exported `EntityRepository`, `NonCachedEntityRepository`, `EntityFormat` classes to be able to extend formats
  in models
- Exported helper `codeToName` function 

## [1.11.6] - 2020-03-19
### Fixed
- Fixed bug when domainInfo is provided to migrateDir from outside and it is an extended domainInfo

## [1.11.5] - 2020-03-19
### Fixed
- Workaround for cached domain info

## [1.11.4] - 2020-03-18
### Fixed
- Used global context in `migrateFile` too

## [1.11.3] - 2020-03-16
### Fixed
- Until before ALL models migrate their ub-migrate extensions according to notes 1.9.0, introduce a global context.
  The problem was that requiring modules more than once will not cause execution module code more than once and
  the extension code may not extend 2 different container instances. 

## [1.11.2] - 2020-03-16
### Fixed
- Critical bug with support of new way of extension description in 1.9.0

## [1.11.0]

### Added
- Support for majority of entities in "CDN" model: organizations, departments, employees, admin units, etc.
- Added method `migrateFile`
### Changed
- Made "container" more strict to better failure console messages: if file type or repository not found, give a clear error message

## [1.10.0]

### Added
- Support for majority of entities in "ORG" model: organizations, departments, staff units, employees, etc.
- Support necessary dictionaries from CDN
- Support for contacts for ORG

## [1.9.3]

### Fixed
- Fixed critical for Linux

## [1.9.2]

### Fixed
- Added repository for `uba_usergroup`.  Appeared that the following construct did not work, and it is fixed now:
```yaml
- u03:
    firstName: u03_fn
    lastName: u03_ln
    groups:
    - g01
    - g02
```

## [1.9.1]

### Fixed
* Fix for `migrateDir` function
* Fix problem when only part of models migrated and formats from the models not included for migration were not loaded,
  that would make it impossible to create entities of other models, if they not migrated too.

## [1.9.0]

### Added
* New command line mode: silent

### Changed
* Updated all dependencies

OBSOLETION NOTE:
  ub-migrate formats and repositories extensions now shall export a function rather than just be modules.
  The function takes "container" as an argument, the "container" parameter MUST NOT be used from "extend" module,
  it is obsolete now.

Was:

```javascript
const {
  EntityFormat,
  EntityRepository,
  // This MUST NOT be used, is obsolete
  container
} = require('@unitybase/ub-migrate').extend

container.registerRepository(
  'cdn_classifier',
  new EntityRepository(
    'cdn_classifier',
    ['code'],
    [],
    ['name']
  )
)
```

Become:

```javascript
const {
  EntityFormat,
  EntityRepository,
} = require('@unitybase/ub-migrate').extend

module.exports = function (container) {
  container.registerRepository(
    'cdn_classifier',
    new EntityRepository(
      'cdn_classifier',
      ['code'],
      [],
      ['name']
    )
  )
}
```

It is an easy migration, do it once you migrate to ub-migrate 1.9+

## [1.8.3]

### Added
* Support of `ubm_desktop.iconCls`

## [1.8.2]

### Added
* Support of `ubm_desktop.description`.

## [1.8.1]

### Added
* Support of `uba_user.lastPasswordChangeDate`. Make uba_user's fields `lastPasswordChangeDate` and `uPasswordHashHexa` non-updatable

## [1.8.0]

### Added
* Ability to specify lookup attributes in entity formats
* Exposed `EntityRepository`, `EntityFormat` and `container` from `extend.js`, to allow complex
  file format definitions.

### Changed
* Navigation shortcuts: in addition to automatic detection of `isFolder` attribute value, added ability to override,
  to allow empty folder creation:
  ```yaml
  dsk_test:
    $amendment: true
    items:
    - folder:
        isFolder: true
  ```
* Improved error message `md is undefined`.  In most of cases, now developer will see much more useful error message.

## [1.7.1]

### Added
* Add feature of repository objects to emit `insert:before`, `insert:after`, `update:before` and `update:after`
  events, so that it is possible to tweak content of execParams before the operation
* Support for `$noDefaults: true` yaml option, which prevents undesired default values for update operations.

### Changed
* `uba_role.allowedAppMethods` now append new roles, it does not overwrite value anymore!
  * **!!!** This could be a breaking change, be careful, when you want to remove allowedAppMethods, it shall be
    done with a custom scripts or manually 

## [1.6.12]

### Changed
* Added a few more unit-tests for shortcuts.

### Fixed
* Made example from README.md work: `cmd` property of shortcut.

## [1.6.11]

### Fixed
* Made `uba_user.trustedID` non-updatable, so that once user created, each subsequent update its `trustedIP` won't be
  reset to its initial value.  Sometimes, some users accounts are created via migration scripts, such as service
  accounts, which must always by for an application.  But `trustedIP` is configured per-environment.

## [1.6.10]

### Fixed
* Corrected work of updating `uba_role.allowedAppMethods` and `uba_role.sessionTimeout`

## [1.6.9]

### Fixed
* Corrected work of `uba_role.allowedAppMethods`

## [1.6.8]

### Added
* Support of `uba_user.trustedIP`

## [1.6.7]

### Fixed
* `uba_role` shortcuts mask - replace `*` symbol to 0-many symbols instead of 1-many, so that `uba_user*` would also
  match `uba_user`, not just `uba_usergroup`.

## [1.6.6]

### Fixed
* DB initialization without CDN / ORG models. 

## [1.6.4]

### Changed
* Function "extend" to accept 2 more arguments: `lookupAttributes` and `nonUpdatableAttributes`.  The first one
  is for future use, ignored for now.  If pass, pass undefined only.  But the second is passed down to
  `EntityRepository` class and shall be used for values, which must not be subsequently updated.  For example,
  a dictionary entry created with a specific code must never be updated since creation, because it contains some
  environment specific setting.

### Fixed
* Do not register predefined model, if the model is not in the model list to migrate.

## [1.6.2]

### Fixed
* Only the first shortcut mask applied.

## [1.6.1]

### Added
* Navigation - can now customize code of form to be shown in the showList, by specifying `formCode` within `showList`:

```yaml
app_shortcut_code:
  caption: {en: Price Forecasting, uk: Передбачення цін}
  showList:
    entity: dct_SkuItem
    fieldList:
    - code
    - name
    - parameters
    - uomID
    - price
  formCode: dct_SkuItem-prices
```

## [1.6.0]

### Added
* Added "smart navigation shortcuts" permissions for roles.  The following example would add permissions for
  all existing navigation shortcuts starting from "mdm_", also will give permission to their parent shortcut folders,
  and desktop or desktops they are in: 
```yaml
mdm_manager: 
  description: Master Data Manager
  els: 
    crud: mdm, org, cdn
  shortcuts: 
  - mdm_*
```
 
* `uba_group` with mapping to roles and children users, so user to group member ship may be now defined from both ways:
  groups of a user or users of a group
* Added groups detail inside `users` definitions

### Fixed
* uba - fixed method masks (in 1.5.6 fix was for unit-tests only).

### Changed
* Refactoring: instead of `fileTypes/index.js` and `repositories/index.js` as containers for file types and
  repositories, introduced the `container.js` module as keeper of all available repositories and file types and
  have registration modules.

## [1.5.12]

### Fixed
* Critical bug with "copy" attributes, which led to `iconCls` not set for `ubm_navshortcut`.
* Typo in `cdn_profession`

## [1.5.10]

### Added
* Support for `org_profession`

## [1.5.8]

### Added
* Support for `cdn_profession`

## [1.5.6]

### Changed
* Logged object insertion.

### Fixed
* uba - fixed method masks.

## [1.5.0]

### Added
- Analyzed if there are javascript files in "_data" directory, if so, load them before processing data.
  This allows to add support for additional data formats in yaml.
- Added a module for help extension: "extend":

  ```javascript
  const extend = require('@unitbase/ub-migrate').extend
  extend.registerEntity('cdn_organization', 'code', [], ['name', 'fullName'])
  ```

## [1.4.2]

### Changed
- Added `uPasswordHashHexa` to `uba_user`

## [1.4.1]

### Fixed
- Some bugs with introduced CDN entities support

## [1.4.0]

### Added
- Support for CDN entities: `cdn_deptype` and `cdn_orgbusinesstype`

## [1.3.0]

### Changed
- API to be able to use it in `_initialData`

## [1.2.9]

### Fixed
- critical for `ubs_settings` bug - translatable attributes

## [1.2.8]

### Added
- Added feature to not update some attributes, once instance is inserted.
  This is to prevent overwrite `ubs_settings.settingValue` attribute on subsequent migrations to its initial value.

### Fixed
- `ubs_settings` - default value for `description`, added missed `type` attribute

## [1.2.7]

### Added
- Initial support for `ubs_settings`

### Fixed
- bug with "description" attribute of user and role
- fixed critical for `uba_user` bug - added repository object for appropriate entities to be able to save instances 

## [1.2.6]

### Added
- `uba_user` + `uba_userrole` description.  Useful for special user accounts, like integration and for unit-tests

FIX:
- Critical: ubm_metadata - replaced object spread operator with Object.assign call, because UB does not support object
  spread 

## [1.2.5]

### Added
- Support for `showForm` navigation shortcuts
- Automatically add `UB.i18n` to `showList` attribute description, so that only key shall be specified
    ```yaml
    fieldList:
    - name: processDefinitionID.name
      description: bpm_Process.processDefinitionID
    ``` 
- Added support for `hideActions` property for `showList`

## [1.2.4]

### Added
- `$amendment` attribute on objects, which shall allow adding child items to existing parent

### Changed
- ELS: replaced * method mask with "all" for custom rules in code and description

## [1.2.3]

### Changed
- Better support for custom ELS methods

## [1.2.2]

### Changed
- Added support for "full" ELS rights to models

## [1.2.1]

### Fixed
- Sorted list of files in _data directory, before processing them

## [1.2.0]

### Changed
- Big refactoring of parsing logic, not instead of imperative style, declarative style is used, which opens up
  possibility of easy adding support for new entity types.  New features covered with unit-tests.  

## [1.1.0]

### Added
- Supported multiple yaml documents in the same file
- Added top-level $context object support, with property "type":
```yaml
$context:
- type: enums

DOC_STATUS:
- draft: {ru: ????????, uk: ????????}
- on_review: {ru: ?? ???????,uk: ?? ???????}
```
- Added scanning of all *.yml and *.yaml files in directory, detect file type as a file name

### Changed
- Support specifying string value is a value of translatable attribute - it will be treat as a value for
  default language.

### Fixed
- Included lookup target attributes into list of updatable attributes

## [1.0.6]

### Changed
* For navigation, added support for `format` JS code for grid columns.

## [1.0.4]

### Changed
* Before parsing `ubConfig.json`, substitute environment variable references.

## [1.0.2]

### Changed
- Navigation shortcuts now capable to guess entity for `showForm` and `showList` by shortcut code.  If they match,
  entity may be omitted.

## [1.0.1]

### Fixed
* Method mask built for ELS did not work properly, because UnityBase does not support full regular expressions, but
  rather a subset of them.  Fixed to base on first letter of method name, like other UnityBase models do, for example:
  `[iuda]*` - for `insert`, `update`, `delete` and `addnew`.
* Fixed building navigation shortcuts for `showForm` and `showList` - wrapped `params` into an array

## [1.0.0]

Initial version.
